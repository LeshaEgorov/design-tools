<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MidAPI Midjourney Studio</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0"
    />
    <link rel="stylesheet" href="styles.css" />
    <script defer src="script.js"></script>
  </head>
  <body>
    <header class="app-header">
      <div class="branding">
        <div class="logo-circle">MJ</div>
        <div class="titles">
          <h1>MidAPI Midjourney Studio</h1>
          <p>Генерация изображений через MidAPI с наглядным мониторингом прогресса.</p>
        </div>
      </div>
      <div class="connection-status" id="connectionStatus">
        <span class="status-indicator"></span>
        <span class="status-text">Ожидание настроек</span>
      </div>
    </header>

    <main class="layout">
      <section class="card config-card">
        <div class="card-header">
          <h2>Подключение к MidAPI</h2>
          <button type="button" class="link-button" id="clearSettingsBtn">Сбросить</button>
        </div>
        <form class="config-form" autocomplete="off">
          <label class="field">
            <span class="field-label">Базовый URL</span>
            <input
              type="text"
              id="baseUrlInput"
              placeholder="https://api.midapi.ai"
              spellcheck="false"
              autocomplete="off"
            />
          </label>
          <label class="field">
            <span class="field-label">Endpoint imagine</span>
            <input
              type="text"
              id="imaginePathInput"
              placeholder="/midjourney/imagine"
              spellcheck="false"
            />
          </label>
          <label class="field">
            <span class="field-label">Endpoint статуса</span>
            <input
              type="text"
              id="statusPathInput"
              placeholder="/midjourney/message/{id}"
              spellcheck="false"
            />
            <small class="field-hint">Используйте {id} как подстановку идентификатора задачи.</small>
          </label>
          <label class="field">
            <span class="field-label">API ключ</span>
            <input
              type="password"
              id="apiKeyInput"
              placeholder="Введите ваш API ключ"
              autocomplete="off"
            />
            <small class="field-hint">
              Ключ хранится в браузере (LocalStorage) и никогда не отправляется на сторонние ресурсы.
            </small>
          </label>
          <label class="field">
            <span class="field-label">Discord Token (опционально)</span>
            <input
              type="password"
              id="discordTokenInput"
              placeholder="Если требуется токен сессии Midjourney"
              autocomplete="off"
            />
          </label>
          <label class="field">
            <span class="field-label">Webhook URL (опционально)</span>
            <input
              type="url"
              id="webhookInput"
              placeholder="https://example.com/webhook"
              autocomplete="off"
            />
          </label>
        </form>
      </section>

      <section class="card prompt-card">
        <div class="card-header">
          <h2>Создание запроса</h2>
          <div class="header-actions">
            <label class="toggle">
              <input type="checkbox" id="liveJsonToggle" />
              <span>Показывать JSON</span>
            </label>
          </div>
        </div>
        <form id="promptForm" class="prompt-form">
          <label class="field">
            <span class="field-label">Промпт</span>
            <textarea
              id="promptInput"
              rows="4"
              placeholder="Опишите изображение, которое хотите получить"
              required
            ></textarea>
          </label>
          <label class="field">
            <span class="field-label">Негативный промпт</span>
            <textarea
              id="negativePromptInput"
              rows="2"
              placeholder="Что следует исключить из изображения"
            ></textarea>
          </label>

          <div class="inline-fields">
            <label class="field">
              <span class="field-label">Количество вариаций</span>
              <input type="number" id="imageCountInput" min="1" max="4" value="1" />
            </label>
            <label class="field">
              <span class="field-label">Соотношение сторон</span>
              <select id="aspectRatioSelect">
                <option value="">По умолчанию</option>
                <option value="1:1">1:1</option>
                <option value="2:3">2:3</option>
                <option value="3:2">3:2</option>
                <option value="16:9">16:9</option>
                <option value="21:9">21:9</option>
                <option value="9:16">9:16</option>
                <option value="4:5">4:5</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">Качество</span>
              <select id="qualitySelect">
                <option value="standard">standard</option>
                <option value="high">high</option>
                <option value="low">low</option>
              </select>
            </label>
          </div>

          <div class="inline-fields">
            <label class="field">
              <span class="field-label">Stylize</span>
              <input type="number" id="stylizeInput" min="0" max="1000" step="50" value="100" />
            </label>
            <label class="field">
              <span class="field-label">Chaos</span>
              <input type="number" id="chaosInput" min="0" max="100" step="5" value="0" />
            </label>
            <label class="field">
              <span class="field-label">Seed</span>
              <input type="number" id="seedInput" min="0" placeholder="Случайный" />
            </label>
          </div>

          <details class="advanced">
            <summary>Дополнительные опции</summary>
            <div class="advanced-grid">
              <label class="field">
                <span class="field-label">Модель / Версия</span>
                <input type="text" id="modelVersionInput" placeholder="Например, 5.2, niji, turbo" />
              </label>
              <label class="field">
                <span class="field-label">Preset (режим)</span>
                <select id="presetSelect">
                  <option value="">По умолчанию</option>
                  <option value="fast">fast</option>
                  <option value="relax">relax</option>
                  <option value="turbo">turbo</option>
                </select>
              </label>
              <label class="field">
                <span class="field-label">Ref image URLs (через запятую)</span>
                <textarea id="referenceImagesInput" rows="2" placeholder="https://..." ></textarea>
              </label>
              <label class="field">
                <span class="field-label">Дополнительные параметры JSON</span>
                <textarea
                  id="extraJsonInput"
                  rows="3"
                  placeholder='{"style": "anime", "tile": true}'
                ></textarea>
              </label>
            </div>
          </details>

          <div class="form-footer">
            <button type="submit" class="primary-button">Сгенерировать</button>
            <button type="button" id="resetFormBtn" class="ghost-button">Очистить форму</button>
          </div>
        </form>

        <section class="json-preview" id="jsonPreview" hidden>
          <div class="card-header">
            <h3>Предпросмотр JSON запроса</h3>
            <button type="button" class="link-button" id="copyJsonBtn">Скопировать</button>
          </div>
          <pre id="jsonPreviewContent"></pre>
        </section>
      </section>

      <section class="card results-card">
        <div class="card-header">
          <h2>История запросов</h2>
          <button type="button" class="link-button" id="clearHistoryBtn">Очистить</button>
        </div>
        <div id="tasksContainer" class="tasks"></div>
        <div class="empty-state" id="emptyState">
          <p>Пока что запросов нет. Заполните промпт и нажмите «Сгенерировать».</p>
        </div>
      </section>
    </main>

    <template id="taskTemplate">
      <article class="task-card">
        <header class="task-header">
          <div>
            <h3 class="task-title"></h3>
            <div class="task-meta"></div>
          </div>
          <div class="task-status">
            <span class="status-chip"></span>
            <button type="button" class="icon-button" data-action="toggle-json" title="Показать JSON">
              <span class="material-symbols">data_object</span>
            </button>
          </div>
        </header>
        <div class="task-progress">
          <div class="progress-bar"><span></span></div>
          <div class="progress-text"></div>
        </div>
        <div class="task-images"></div>
        <details class="task-json" hidden>
          <summary>Детали ответа</summary>
          <div class="json-columns">
            <div>
              <h4>Запрос</h4>
              <pre class="request-json"></pre>
            </div>
            <div>
              <h4>Ответ</h4>
              <pre class="response-json"></pre>
            </div>
          </div>
        </details>
        <footer class="task-footer">
          <button type="button" class="ghost-button" data-action="refresh">Обновить</button>
          <button type="button" class="ghost-button" data-action="copy-result">Скопировать JSON</button>
          <button type="button" class="link-button" data-action="open-original" disabled>Открыть оригинал</button>
        </footer>
      </article>
    </template>

    <dialog id="toast" class="toast" aria-live="polite"></dialog>
  </body>
</html>
